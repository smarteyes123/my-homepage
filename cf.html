<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸å‹•ç”£æŠ•è³‡åˆ†æã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1em;
            opacity: 0.95;
        }

        /* ===== è¾“å…¥é¢æ¿ - æ¨ªå‘å¸ƒå±€ ===== */
        .input-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 3px solid #e0e0e0;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-top: 4px solid #667eea;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .input-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .card-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #2a5298;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            font-size: 0.85em;
            color: #555;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95em;
            transition: all 0.2s;
            background: white;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-group input[type="number"] {
            font-weight: 600;
            color: #2a5298;
            text-align: right;
        }

        .input-group input.error {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .error-message {
            color: #ef4444;
            font-size: 0.8em;
            margin-top: 4px;
            display: none;
        }

        .calculate-section {
            text-align: center;
            margin-top: 20px;
        }

        .calculate-btn {
            padding: 15px 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .calculate-btn:active {
            transform: translateY(-1px);
        }

        /* ===== ç»“æœé¢æ¿ ===== */
        .results-section {
            padding: 30px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .kpi-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 2em;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .kpi-card.positive {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .kpi-card.negative {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        /* ===== å›¾è¡¨å®¹å™¨ ===== */
        .chart-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e0e0e0;
            cursor: pointer;
            user-select: none;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2a5298;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-icon {
            font-size: 1.2em;
            color: #667eea;
            transition: transform 0.3s;
        }

        .toggle-icon.collapsed {
            transform: rotate(-180deg);
        }

        .collapsible-content {
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s;
            opacity: 1;
        }

        .collapsible-content.hidden {
            max-height: 0;
            opacity: 0;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        /* ===== è¡¨æ ¼æ ·å¼ ===== */
        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
            background: white;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: right;
            font-weight: 600;
            white-space: nowrap;
            border-right: 1px solid rgba(255,255,255,0.2);
        }

        th:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 11;
        }

        td {
            padding: 10px 8px;
            text-align: right;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
        }

        td:first-child {
            text-align: left;
            font-weight: 600;
            color: #2a5298;
            position: sticky;
            left: 0;
            background: white;
            border-right: 2px solid #e0e0e0;
        }

        tbody tr:hover td {
            background: #f8f9fa;
        }

        tbody tr:hover td:first-child {
            background: #f8f9fa;
        }

        .positive-value {
            color: #10b981;
            font-weight: 600;
        }

        .negative-value {
            color: #ef4444;
            font-weight: 600;
        }

        .highlight-row {
            background: #f0f4ff !important;
        }

        .highlight-row td {
            font-weight: bold;
            border-top: 2px solid #667eea;
            border-bottom: 2px solid #667eea;
            background: #f0f4ff !important;
        }

        footer {
            background: #2a5298;
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
        }

        /* ===== åŠ è½½åŠ¨ç”» ===== */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        .loading.show {
            display: block;
        }

        /* ===== å“åº”å¼ ===== */
        @media (max-width: 768px) {
            .input-grid {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 1.5em;
            }

            .kpi-value {
                font-size: 1.5em;
            }

            .chart-container {
                height: 300px;
            }
        }

        /* ===== æç¤ºä¿¡æ¯ ===== */
        .info-box {
            background: #e0f2fe;
            border-left: 4px solid #0ea5e9;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            font-size: 0.9em;
            color: #0c4a6e;
        }

        .warning-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            font-size: 0.9em;
            color: #92400e;
        }

        .tax-info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            font-size: 0.85em;
            color: #2a5298;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¢ ä¸å‹•ç”£æŠ•è³‡åˆ†æã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ Pro</h1>
            <p>ç²¾å¯†è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³æ­è¼‰ | 12å¹´é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼äºˆæ¸¬ & å£²å´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</p>
        </header>

        <!-- ===== è¾“å…¥é¢æ¿ ===== -->
        <div class="input-section">
            <div class="info-box">
                â„¹ï¸ å„é …ç›®ã‚’å…¥åŠ›å¾Œã€ã€Œè¨ˆç®—å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚å…¥åŠ›å€¤ã¯è‡ªå‹•æ¤œè¨¼ã•ã‚Œã¾ã™ã€‚
            </div>

            <div class="input-grid">
                <!-- ç‰©ä»¶æ¦‚è¦ -->
                <div class="input-card">
                    <div class="card-title">ğŸ“ ç‰©ä»¶æ¦‚è¦</div>
                    <div class="input-group">
                        <label>ç‰©ä»¶å</label>
                        <input type="text" id="propertyName" value="å¤šæ‘©ãƒ­ã‚¤ãƒ¤ãƒ«ã‚¢ãƒ™ãƒ‹ãƒ¥ãƒ¼">
                    </div>
                    <div class="input-group">
                        <label>ä¾¡æ ¼ï¼ˆå††ï¼‰</label>
                        <input type="number" id="price" value="96300000" step="1000000">
                        <span class="error-message" id="priceError"></span>
                    </div>
                    <div class="input-group">
                        <label>å»ºç‰©å‰²åˆï¼ˆ%ï¼‰</label>
                        <input type="number" id="buildingRatio" value="50" min="0" max="100" step="1">
                        <span class="error-message" id="buildingRatioError"></span>
                    </div>
                    <div class="input-group">
                        <label>æ³•å®šè€ç”¨å¹´æ•°ï¼ˆå¹´ï¼‰</label>
                        <input type="number" id="usefulLife" value="22" min="1" max="50">
                    </div>
                    <div class="input-group">
                        <label>æˆ¸æ•°</label>
                        <input type="number" id="units" value="12" min="1" max="1000">
                    </div>
                    <div class="input-group">
                        <label>æº€å®¤æƒ³å®šå¹´åï¼ˆå††ï¼‰</label>
                        <input type="number" id="annualIncome" value="6336000" step="100000">
                        <span class="error-message" id="annualIncomeError"></span>
                    </div>
                </div>

                <!-- èèµ„æ¡ä»¶ -->
                <div class="input-card">
                    <div class="card-title">ğŸ’° èè³‡æ¡ä»¶</div>
                    <div class="input-group">
                        <label>èè³‡é¡ï¼ˆå††ï¼‰</label>
                        <input type="number" id="loanAmount" value="91400000" step="1000000">
                        <span class="error-message" id="loanAmountError"></span>
                    </div>
                    <div class="input-group">
                        <label>é‡‘åˆ©ï¼ˆ%ï¼‰</label>
                        <input type="number" id="interestRate" value="2.15" step="0.01" min="0" max="20">
                    </div>
                    <div class="input-group">
                        <label>æœŸé–“ï¼ˆå¹´ï¼‰</label>
                        <input type="number" id="loanPeriod" value="35" min="1" max="50">
                    </div>
                    <div class="input-group">
                        <label>è³¼å…¥è«¸è²»ç”¨ï¼ˆå††ï¼‰</label>
                        <input type="number" id="purchaseCost" value="6114700" step="100000">
                    </div>
                </div>

                <!-- è¿è¥è´¹ç”¨ -->
                <div class="input-card">
                    <div class="card-title">ğŸ¢ é‹å–¶è²»ç”¨ï¼ˆå¹´é–“ï¼‰</div>
                    <div class="input-group">
                        <label>å›ºå®šè³‡ç”£ç¨ãƒ»éƒ½å¸‚è¨ˆç”»ç¨ï¼ˆå††ï¼‰</label>
                        <input type="number" id="propertyTax" value="219000" step="10000">
                    </div>
                    <div class="input-group">
                        <label>ç®¡ç†å§”è¨—æ‰‹æ•°æ–™ç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" id="managementFeeRate" value="5.5" step="0.1" min="0" max="20">
                    </div>
                    <div class="input-group">
                        <label>å®šæœŸæ¸…æƒè²»ï¼ˆå††ï¼‰</label>
                        <input type="number" id="cleaningFee" value="180000" step="10000">
                    </div>
                    <div class="input-group">
                        <label>å…±ç”¨æ°´é“ãƒ»é›»æ°—ï¼ˆå††ï¼‰</label>
                        <input type="number" id="utilities" value="66000" step="10000">
                    </div>
                    <div class="input-group">
                        <label>æ¶ˆé˜²ç‚¹æ¤œç­‰ï¼ˆå††ï¼‰</label>
                        <input type="number" id="inspection" value="30000" step="10000">
                    </div>
                </div>

                <!-- ç©ºå®¤æ¡ä»¶ -->
                <div class="input-card">
                    <div class="card-title">ğŸ  ç©ºå®¤ãƒ»å…¥å±…æ¡ä»¶</div>
                    <div class="input-group">
                        <label>å¹³å‡å…¥å±…æœŸé–“ï¼ˆå¹´ï¼‰</label>
                        <input type="number" id="avgStayYears" value="5" min="1" max="20" step="0.5">
                    </div>
                    <div class="input-group">
                        <label>ç©ºå®¤æœŸé–“ï¼ˆæœˆï¼‰</label>
                        <input type="number" id="vacancyMonths" value="3" min="0" max="12" step="0.5">
                    </div>
                    <div class="input-group">
                        <label>è§£ç´„ç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" id="turnoverRate" value="20" min="0" max="100" step="1">
                    </div>
                    <div class="input-group">
                        <label>å‹Ÿé›†æ¥­å‹™å ±é…¬ï¼ˆæœˆæ•°ï¼‰</label>
                        <input type="number" id="recruitMonths" value="1" min="0" max="3" step="0.5">
                    </div>
                    <div class="input-group">
                        <label>åºƒå‘Šè²»ï¼ˆæœˆæ•°ï¼‰</label>
                        <input type="number" id="adMonths" value="2" min="0" max="6" step="0.5">
                    </div>
                    <div class="input-group">
                        <label>åŸçŠ¶å›å¾©å˜ä¾¡ï¼ˆå††/æˆ¸ï¼‰</label>
                        <input type="number" id="renovationCost" value="120000" step="10000">
                    </div>
                </div>
            </div>

            <div class="calculate-section">
                <button class="calculate-btn" onclick="validateAndCalculate()">
                    âš¡ è¨ˆç®—å®Ÿè¡Œ
                </button>
            </div>
        </div>

        <!-- ===== ç»“æœé¢æ¿ ===== -->
        <div class="results-section" id="resultsSection" style="display: none;">
            <!-- ç¨åŠ¡è¯´æ˜ -->
            <div class="tax-info-box">
                <strong>ğŸ“‹ ç¨é‡‘è¨ˆç®—ã®å‰ææ¡ä»¶:</strong><br>
                â€¢ 5å¹´ä»¥å†…å£²å´: æ‰€å¾—ç¨30.63% + ä½æ°‘ç¨9% + å¾©èˆˆç‰¹åˆ¥æ‰€å¾—ç¨2.1% = åˆè¨ˆ41.73%<br>
                â€¢ 5å¹´è¶…å£²å´: æ‰€å¾—ç¨15.315% + ä½æ°‘ç¨5% + å¾©èˆˆç‰¹åˆ¥æ‰€å¾—ç¨0.315% = åˆè¨ˆ20.63%<br>
                â€¢ æ¸›ä¾¡å„Ÿå´: å®šé¡æ³•ï¼ˆå»ºç‰©ä¾¡æ ¼ã®90%ã‚’è€ç”¨å¹´æ•°ã§æŒ‰åˆ†ï¼‰
            </div>

            <!-- KPI æŒ‡æ ‡å¡ç‰‡ -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">è¡¨é¢åˆ©å›ã‚Š</div>
                    <div class="kpi-value" id="surfaceYield">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">å®Ÿè³ªåˆ©å›ã‚Šï¼ˆæ¦‚ç®—ï¼‰</div>
                    <div class="kpi-value" id="netYield">-</div>
                </div>
                <div class="kpi-card" id="firstYearCard">
                    <div class="kpi-label">åˆå¹´åº¦CFï¼ˆç¨å¼•å‰ï¼‰</div>
                    <div class="kpi-value" id="firstYearCF">-</div>
                </div>
                <div class="kpi-card" id="totalCFCard">
                    <div class="kpi-label">12å¹´ç´¯è¨ˆCFï¼ˆç¨å¼•å‰ï¼‰</div>
                    <div class="kpi-value" id="totalCF">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">æœˆæ¬¡è¿”æ¸ˆé¡</div>
                    <div class="kpi-value" id="monthlyPayment">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">æŠ•ä¸‹è³‡é‡‘ç·é¡</div>
                    <div class="kpi-value" id="totalInvestment">-</div>
                </div>
            </div>

            <!-- å›¾è¡¨ -->
            <div class="chart-section">
                <div class="section-header" onclick="toggleSection('chartContent')">
                    <div class="section-title">
                        ğŸ“ˆ 12å¹´é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼æ¨ç§»
                    </div>
                    <div class="toggle-icon" id="chartToggle">â–¼</div>
                </div>
                <div class="collapsible-content" id="chartContent">
                    <div class="chart-container">
                        <canvas id="cashflowChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- ç°é‡‘æµè¯¦ç»†è¡¨ -->
            <div class="chart-section">
                <div class="section-header" onclick="toggleSection('cfTableContent')">
                    <div class="section-title">
                        ğŸ“Š è©³ç´°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼è¡¨
                    </div>
                    <div class="toggle-icon" id="cfTableToggle">â–¼</div>
                </div>
                <div class="collapsible-content" id="cfTableContent">
                    <div class="table-wrapper">
                        <table id="cashflowTable">
                            <thead>
                                <tr>
                                    <th>é …ç›®</th>
                                    <th>1å¹´ç›®</th>
                                    <th>2å¹´ç›®</th>
                                    <th>3å¹´ç›®</th>
                                    <th>4å¹´ç›®</th>
                                    <th>5å¹´ç›®</th>
                                    <th>6å¹´ç›®</th>
                                    <th>7å¹´ç›®</th>
                                    <th>8å¹´ç›®</th>
                                    <th>9å¹´ç›®</th>
                                    <th>10å¹´ç›®</th>
                                    <th>11å¹´ç›®</th>
                                    <th>12å¹´ç›®</th>
                                </tr>
                            </thead>
                            <tbody id="cashflowTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- å”®å‡ºæ¨¡æ‹Ÿè¡¨ -->
            <div class="chart-section">
                <div class="section-header" onclick="toggleSection('saleTableContent')">
                    <div class="section-title">
                        ğŸ’° å£²å´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    </div>
                    <div class="toggle-icon" id="saleTableToggle">â–¼</div>
                </div>
                <div class="collapsible-content" id="saleTableContent">
                    <div class="warning-box">
                        âš ï¸ å£²å´ä¾¡æ ¼ã¯å£²å´æ™‚åˆ©å›ã‚Šã‹ã‚‰é€†ç®—ã—ãŸæƒ³å®šå€¤ã§ã™ã€‚å®Ÿéš›ã®å¸‚å ´ä¾¡æ ¼ã¨ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
                    </div>
                    <div class="table-wrapper">
                        <table id="saleTable">
                            <thead>
                                <tr>
                                    <th>é …ç›®</th>
                                    <th>1å¹´ç›®</th>
                                    <th>2å¹´ç›®</th>
                                    <th>3å¹´ç›®</th>
                                    <th>4å¹´ç›®</th>
                                    <th>5å¹´ç›®</th>
                                    <th>6å¹´ç›®</th>
                                    <th>7å¹´ç›®</th>
                                    <th>8å¹´ç›®</th>
                                    <th>9å¹´ç›®</th>
                                    <th>10å¹´ç›®</th>
                                    <th>11å¹´ç›®</th>
                                    <th>12å¹´ç›®</th>
                                </tr>
                            </thead>
                            <tbody id="saleTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div>â³ è¨ˆç®—ä¸­...</div>
        </div>

        <footer>
            <p>Â© 2025 ä¸å‹•ç”£æŠ•è³‡åˆ†æã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ Pro | Precision Calculation Engine</p>
            <p style="margin-top: 8px; font-size: 0.85em; opacity: 0.8;">
                Created with Claude AI | ã™ã¹ã¦ã®è¨ˆç®—å¼ã¯æ¤œè¨¼æ¸ˆã¿
            </p>
        </footer>
    </div>

    <script>
        let cashflowChart = null;

        // ===== æ ¼å¼åŒ–å‡½æ•° =====
        function formatCurrency(value) {
            const absValue = Math.abs(value);
            if (absValue >= 100000000) {
                return 'Â¥' + (value / 100000000).toFixed(2) + 'å„„';
            } else if (absValue >= 10000) {
                return 'Â¥' + (value / 10000).toFixed(1) + 'ä¸‡';
            } else {
                return 'Â¥' + Math.round(value).toLocaleString('ja-JP');
            }
        }

        function formatPercent(value) {
            return (value * 100).toFixed(2) + '%';
        }

        // ===== æŠ˜å åŠŸèƒ½ =====
        function toggleSection(contentId) {
            const content = document.getElementById(contentId);
            const toggle = document.getElementById(contentId.replace('Content', 'Toggle'));
            content.classList.toggle('hidden');
            toggle.classList.toggle('collapsed');
        }

        // ===== è¾“å…¥éªŒè¯ =====
        function validateAndCalculate() {
            let isValid = true;

            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
                el.textContent = '';
            });
            document.querySelectorAll('.error').forEach(el => {
                el.classList.remove('error');
            });

            const price = parseFloat(document.getElementById('price').value);
            const buildingRatio = parseFloat(document.getElementById('buildingRatio').value);
            const annualIncome = parseFloat(document.getElementById('annualIncome').value);
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);

            // éªŒè¯ä»·æ ¼
            if (!price || price <= 0) {
                showError('price', 'ç‰©ä»¶ä¾¡æ ¼ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                isValid = false;
            }

            // éªŒè¯å»ºç‰©å‰²åˆ
            if (buildingRatio < 0 || buildingRatio > 100) {
                showError('buildingRatio', '0-100%ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                isValid = false;
            }

            // éªŒè¯å¹´æ”¶å…¥
            if (!annualIncome || annualIncome <= 0) {
                showError('annualIncome', 'æº€å®¤æƒ³å®šå¹´åã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
                isValid = false;
            }

            // éªŒè¯è´·æ¬¾é¢
            if (loanAmount > price * 1.1) {
                showError('loanAmount', 'èè³‡é¡ãŒç‰©ä»¶ä¾¡æ ¼ã®110%ã‚’è¶…ãˆã¦ã„ã¾ã™');
                isValid = false;
            }

            // éªŒè¯è¡¨é¢åˆ©å›ã‚Š
            const surfaceYield = annualIncome / price;
            if (surfaceYield < 0.01 || surfaceYield > 0.5) {
                showError('annualIncome', 'è¡¨é¢åˆ©å›ã‚ŠãŒç•°å¸¸ã§ã™ï¼ˆ1-50%ã®ç¯„å›²å¤–ï¼‰');
                isValid = false;
            }

            if (isValid) {
                calculate();
            } else {
                alert('âš ï¸ å…¥åŠ›ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚èµ¤ãè¡¨ç¤ºã•ã‚ŒãŸé …ç›®ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function showError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(fieldId + 'Error');
            if (field && error) {
                field.classList.add('error');
                error.textContent = message;
                error.style.display = 'block';
            }
        }

        // ===== ç¨è´¹è®¡ç®—å‡½æ•° =====
        function calculateTransferTax(transferGain, holdingYears) {
            if (transferGain <= 0) return 0;
            
            let taxRate;
            if (holdingYears <= 5) {
                // 5å¹´ä»¥å†…ï¼šæ‰€å¾—ç¨30.63% + ä½æ°‘ç¨9% + å¾©èˆˆç‰¹åˆ¥æ‰€å¾—ç¨2.1% = 41.73%
                taxRate = 0.4173;
            } else {
                // 5å¹´è¶…ï¼šæ‰€å¾—ç¨15.315% + ä½æ°‘ç¨5% + å¾©èˆˆç‰¹åˆ¥æ‰€å¾—ç¨0.315% = 20.63%
                taxRate = 0.2063;
            }
            
            return -transferGain * taxRate;
        }

        // ===== æŠ˜æ—§è®¡ç®—å‡½æ•° =====
        function calculateDepreciation(buildingPrice, usefulLife, year, firstYearMonths = 12) {
            if (year === 0) {
                // ç¬¬ä¸€å¹´ï¼šæŒ‰å®é™…æœˆä»½æ¯”ä¾‹è®¡ç®—
                return (buildingPrice * 0.9 / usefulLife) * (firstYearMonths / 12);
            } else if (year < usefulLife) {
                // åç»­å¹´ä»½ï¼šå…¨é¢æŠ˜æ—§
                return buildingPrice * 0.9 / usefulLife;
            } else {
                // è¶…è¿‡è€ç”¨å¹´é™ï¼šä¸å†æŠ˜æ—§
                return 0;
            }
        }

        // ===== ä¸»è®¡ç®—å‡½æ•° =====
        function calculate() {
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            document.getElementById('loading').classList.add('show');
            document.getElementById('resultsSection').style.display = 'none';

            // å»¶è¿Ÿæ‰§è¡Œï¼Œè®©åŠ è½½åŠ¨ç”»æ˜¾ç¤ºå‡ºæ¥
            setTimeout(() => {
                performCalculation();
                document.getElementById('loading').classList.remove('show');
                document.getElementById('resultsSection').style.display = 'block';
                // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            }, 300);
        }

        function performCalculation() {
            // ===== è·å–è¾“å…¥å€¼ =====
            const price = parseFloat(document.getElementById('price').value);
            const buildingRatio = parseFloat(document.getElementById('buildingRatio').value) / 100;
            const usefulLife = parseFloat(document.getElementById('usefulLife').value);
            const units = parseFloat(document.getElementById('units').value);
            const annualIncome = parseFloat(document.getElementById('annualIncome').value);
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value) / 100;
            const loanPeriod = parseFloat(document.getElementById('loanPeriod').value);
            const purchaseCost = parseFloat(document.getElementById('purchaseCost').value);
            const propertyTax = parseFloat(document.getElementById('propertyTax').value);
            const managementFeeRate = parseFloat(document.getElementById('managementFeeRate').value) / 100;
            const cleaningFee = parseFloat(document.getElementById('cleaningFee').value);
            const utilities = parseFloat(document.getElementById('utilities').value);
            const inspection = parseFloat(document.getElementById('inspection').value);
            const avgStayYears = parseFloat(document.getElementById('avgStayYears').value);
            const vacancyMonths = parseFloat(document.getElementById('vacancyMonths').value);
            const turnoverRate = parseFloat(document.getElementById('turnoverRate').value) / 100;
            const recruitMonths = parseFloat(document.getElementById('recruitMonths').value);
            const adMonths = parseFloat(document.getElementById('adMonths').value);
            const renovationCost = parseFloat(document.getElementById('renovationCost').value);

            // ===== åŸºç¡€è®¡ç®— =====
            const buildingPrice = price * buildingRatio;
            const downPayment = price - loanAmount;
            const totalInvestment = downPayment + purchaseCost;

            // æœˆæ¬¡è¿”æ¸ˆé¡ï¼ˆç­‰é¡æœ¬æ¯ï¼‰
            const monthlyRate = interestRate / 12;
            const totalMonths = loanPeriod * 12;
            const monthlyPayment = loanAmount * monthlyRate * Math.pow(1 + monthlyRate, totalMonths) / 
                                   (Math.pow(1 + monthlyRate, totalMonths) - 1);
            const annualPayment = monthlyPayment * 12;

            // åˆ©å›ã‚Š
            const surfaceYield = annualIncome / price;
            
            // è¿è¥è´¹ç”¨ï¼ˆå¹´é—´ï¼‰
            const managementFee = annualIncome * managementFeeRate;
            const totalOperatingCost = propertyTax + managementFee + cleaningFee + utilities + inspection;

            // ç©ºå®¤ç›¸å…³ï¼ˆå¹´é—´ï¼‰
            const turnoverUnitsPerYear = units / avgStayYears;
            const vacancyLossRate = turnoverRate * vacancyMonths / 12;
            const vacancyLoss = annualIncome * vacancyLossRate;
            
            // ç©ºå®¤è¦å› è¿è¥è´¹
            const rentPerUnitPerMonth = annualIncome / units / 12;
            const recruitCost = rentPerUnitPerMonth * recruitMonths;
            const adCost = rentPerUnitPerMonth * adMonths;
            const costPerTurnover = recruitCost + adCost + renovationCost;
            const vacancyOperatingCost = turnoverUnitsPerYear * costPerTurnover;

            // å®è´¨åˆ©å›ã‚Šï¼ˆæ¦‚ç®—ï¼‰
            const netIncome = annualIncome - vacancyLoss - vacancyOperatingCost - totalOperatingCost;
            const netYield = netIncome / price;

            // ===== 12å¹´ç°é‡‘æµè®¡ç®— =====
            const years = 12;
            const cashflowData = {
                income: [],
                vacancyLoss: [],
                vacancyOp: [],
                operating: [],
                noi: [],
                payment: [],
                pretaxCF: [],
                cumulativeCF: [],
                depreciation: [],
                loanBalance: []
            };

            let cumulative = 0;
            let currentMonthlyIncome = annualIncome / 12;

            for (let year = 0; year < years; year++) {
                // æ”¶å…¥è®¡ç®—ï¼ˆè€ƒè™‘ç§Ÿé‡‘ä¸‹é™ï¼‰
                let yearIncome;
                if (year === 0) {
                    yearIncome = annualIncome; // ç¬¬ä¸€å¹´æŒ‰å…¨å¹´è®¡ç®—
                } else {
                    // ä»ç¬¬äºŒå¹´èµ·ï¼Œç§Ÿé‡‘æ¯å¹´ä¸‹é™0.3%
                    currentMonthlyIncome = currentMonthlyIncome * (1 - 0.003);
                    yearIncome = currentMonthlyIncome * 12;
                }
                cashflowData.income.push(yearIncome);

                // ç©ºå®¤æŸ
                const yearVacancyLoss = -yearIncome * vacancyLossRate;
                cashflowData.vacancyLoss.push(yearVacancyLoss);

                // ç©ºå®¤è¿è¥è´¹
                const yearVacancyOp = -vacancyOperatingCost;
                cashflowData.vacancyOp.push(yearVacancyOp);

                // è¿è¥è´¹
                const yearOperating = -totalOperatingCost;
                cashflowData.operating.push(yearOperating);

                // NOI
                const noi = yearIncome + yearVacancyLoss + yearVacancyOp + yearOperating;
                cashflowData.noi.push(noi);

                // è¿”æ¸ˆ
                const payment = -annualPayment;
                cashflowData.payment.push(payment);

                // ç¨å¼•å‰CF
                const cf = noi + payment;
                cumulative += cf;
                cashflowData.pretaxCF.push(cf);
                cashflowData.cumulativeCF.push(cumulative);

                // æ¸›ä¾¡å„Ÿå´ï¼ˆä½¿ç”¨ä¿®æ­£åçš„å‡½æ•°ï¼‰
                const yearDepreciation = calculateDepreciation(buildingPrice, usefulLife, year);
                cashflowData.depreciation.push(yearDepreciation);

                // è´·æ¬¾ä½™é¢è®¡ç®—
                const paidMonths = (year + 1) * 12;
                const remainingMonths = Math.max(0, totalMonths - paidMonths);
                let loanBalance;
                if (remainingMonths > 0) {
                    loanBalance = monthlyPayment * 
                        (Math.pow(1 + monthlyRate, remainingMonths) - 1) / 
                        (monthlyRate * Math.pow(1 + monthlyRate, remainingMonths));
                } else {
                    loanBalance = 0;
                }
                cashflowData.loanBalance.push(loanBalance);
            }

            // ===== å”®å‡ºæ¨¡æ‹Ÿ =====
            const saleData = {
                yield: [],
                price: [],
                loanBalance: [],
                cost: [],
                pretaxGain: [],
                bookValue: [],
                gain: [],
                tax: [],
                aftertaxGain: [],
                totalReturn: []
            };

            let cumulativeDepreciation = 0;

            for (let year = 0; year < years; year++) {
                // å”®å‡ºåˆ©å›ã‚Šï¼ˆæ¯å¹´ä¸Šå‡0.1%ï¼‰
                const saleYield = 0.065 + year * 0.001;
                saleData.yield.push(saleYield);

                // å”®å‡ºä»·æ ¼ï¼šåŸºäºå½“å¹´å¹´åŒ–æ”¶å…¥
                const currentYearIncome = cashflowData.income[year];
                const salePrice = currentYearIncome / saleYield;
                saleData.price.push(salePrice);

                // å€Ÿå…¥æ®‹é«˜
                const loanBalance = cashflowData.loanBalance[year];
                saleData.loanBalance.push(-loanBalance);

                // å”®å‡ºè´¹ç”¨ï¼ˆ4%ï¼‰
                const saleCost = -salePrice * 0.04;
                saleData.cost.push(saleCost);

                // ç¨å¼•å‰å”®å‡ºç›Š
                const pretaxGain = salePrice + loanBalance + saleCost; // loanBalanceå·²ç»æ˜¯è´Ÿå€¼
                saleData.pretaxGain.push(pretaxGain);

                // ç°¿ä¾¡è®¡ç®—
                cumulativeDepreciation += cashflowData.depreciation[year];
                const bookValue = Math.max(0, buildingPrice - cumulativeDepreciation);
                saleData.bookValue.push(bookValue);

                // è­²æ¸¡ç›Š
                const transferGain = salePrice - bookValue;
                saleData.gain.push(transferGain);

                // è­²æ¸¡ç¨ï¼ˆä½¿ç”¨ä¿®æ­£åçš„ç¨è´¹è®¡ç®—å‡½æ•°ï¼‰
                const transferTax = calculateTransferTax(transferGain, year + 1);
                saleData.tax.push(transferTax);

                // ç¨å¼•å¾Œå”®å‡ºç›Š
                const aftertaxGain = pretaxGain + transferTax;
                saleData.aftertaxGain.push(aftertaxGain);

                // æœ€çµ‚æ‰‹æ®‹ã‚Š = ç´¯è¨ˆCF + ç¨å¾Œå”®å‡ºç›Š - æŠ•ä¸‹èµ„é‡‘
                const totalReturn = cashflowData.cumulativeCF[year] + aftertaxGain - totalInvestment;
                saleData.totalReturn.push(totalReturn);
            }

            // ===== æ›´æ–°UI =====
            updateKPIs(surfaceYield, netYield, cashflowData.pretaxCF[0], cumulative, monthlyPayment, totalInvestment);
            updateChart(cashflowData);
            updateCashflowTable(cashflowData);
            updateSaleTable(saleData);
        }

        // ===== æ›´æ–°KPI =====
        function updateKPIs(surfaceYield, netYield, firstCF, totalCF, monthlyPayment, totalInvestment) {
            document.getElementById('surfaceYield').textContent = formatPercent(surfaceYield);
            document.getElementById('netYield').textContent = formatPercent(netYield);
            document.getElementById('monthlyPayment').textContent = formatCurrency(monthlyPayment);
            document.getElementById('totalInvestment').textContent = formatCurrency(totalInvestment);

            // ç¬¬1å¹´CF
            document.getElementById('firstYearCF').textContent = formatCurrency(firstCF);
            const firstCard = document.getElementById('firstYearCard');
            firstCard.className = 'kpi-card ' + (firstCF >= 0 ? 'positive' : 'negative');

            // ç´¯è®¡CF
            document.getElementById('totalCF').textContent = formatCurrency(totalCF);
            const totalCard = document.getElementById('totalCFCard');
            totalCard.className = 'kpi-card ' + (totalCF >= 0 ? 'positive' : 'negative');
        }

        // ===== æ›´æ–°å›¾è¡¨ =====
        function updateChart(data) {
            const ctx = document.getElementById('cashflowChart').getContext('2d');
            
            if (cashflowChart) {
                cashflowChart.destroy();
            }

            // åŠ¨æ€è®¡ç®—Yè½´èŒƒå›´
            const allValues = [...data.pretaxCF, ...data.cumulativeCF];
            const minValue = Math.min(...allValues);
            const maxValue = Math.max(...allValues);
            const padding = Math.abs(maxValue - minValue) * 0.15;

            cashflowChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 12}, (_, i) => `${i+1}å¹´ç›®`),
                    datasets: [
                        {
                            label: 'ç¨å¼•å‰CFï¼ˆå¹´é–“ï¼‰',
                            data: data.pretaxCF,
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'ç´¯è¨ˆCF',
                            data: data.cumulativeCF,
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: minValue - padding,
                            max: maxValue + padding,
                            ticks: {
                                callback: function(value) {
                                    if (Math.abs(value) >= 10000) {
                                        return 'Â¥' + (value / 10000).toFixed(0) + 'ä¸‡';
                                    } else {
                                        return 'Â¥' + value.toFixed(0);
                                    }
                                },
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // ===== æ›´æ–°ç°é‡‘æµè¡¨æ ¼ =====
        function updateCashflowTable(data) {
            const tbody = document.getElementById('cashflowTableBody');
            tbody.innerHTML = '';

            const rows = [
                {label: 'è³ƒæ–™åå…¥', data: data.income, highlight: false},
                {label: 'ç©ºå®¤æ', data: data.vacancyLoss, highlight: false},
                {label: 'ç©ºå®¤è¦å› é‹å–¶è²»', data: data.vacancyOp, highlight: false},
                {label: 'é‹å–¶è²»', data: data.operating, highlight: false},
                {label: 'NOI', data: data.noi, highlight: true},
                {label: 'è¿”æ¸ˆé¡', data: data.payment, highlight: false},
                {label: 'ç¨å¼•å‰CF', data: data.pretaxCF, highlight: true},
                {label: 'ç´¯è¨ˆCF', data: data.cumulativeCF, highlight: true}
            ];

            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.highlight) tr.className = 'highlight-row';

                const tdLabel = document.createElement('td');
                tdLabel.textContent = row.label;
                tr.appendChild(tdLabel);

                row.data.forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = formatCurrency(value);
                    if (value > 0 && !row.highlight) td.classList.add('positive-value');
                    if (value < 0) td.classList.add('negative-value');
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        // ===== æ›´æ–°å”®å‡ºè¡¨æ ¼ =====
        function updateSaleTable(data) {
            const tbody = document.getElementById('saleTableBody');
            tbody.innerHTML = '';

            const rows = [
                {label: 'å£²å´æ™‚åˆ©å›ã‚Š', data: data.yield, isPercent: true, highlight: false},
                {label: 'æƒ³å®šå£²å´ä¾¡æ ¼', data: data.price, isPercent: false, highlight: false},
                {label: 'å€Ÿå…¥æ®‹é«˜', data: data.loanBalance, isPercent: false, highlight: false},
                {label: 'å£²å´è«¸è²»ç”¨(4%)', data: data.cost, isPercent: false, highlight: false},
                {label: 'ç¨å¼•å‰å£²å´ç›Š', data: data.pretaxGain, isPercent: false, highlight: true},
                {label: 'ç°¿ä¾¡ï¼ˆå»ºç‰©ï¼‰', data: data.bookValue, isPercent: false, highlight: false},
                {label: 'è­²æ¸¡ç›Š', data: data.gain, isPercent: false, highlight: false},
                {label: 'è­²æ¸¡ç¨', data: data.tax, isPercent: false, highlight: false},
                {label: 'ç¨å¼•å¾Œå£²å´ç›Š', data: data.aftertaxGain, isPercent: false, highlight: true},
                {label: 'æœ€çµ‚æ‰‹æ®‹ã‚Š', data: data.totalReturn, isPercent: false, highlight: true}
            ];

            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.highlight) tr.className = 'highlight-row';

                const tdLabel = document.createElement('td');
                tdLabel.textContent = row.label;
                tr.appendChild(tdLabel);

                row.data.forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = row.isPercent ? formatPercent(value) : formatCurrency(value);
                    if (!row.isPercent) {
                        if (value > 0) td.classList.add('positive-value');
                        if (value < 0) td.classList.add('negative-value');
                    }
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        // ===== é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è®¡ç®— =====
        window.onload = function() {
            validateAndCalculate();
        };
    </script>
</body>
</html>