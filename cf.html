<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>不動産投資分析シミュレーター Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1em;
            opacity: 0.95;
        }

        .input-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 3px solid #e0e0e0;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-top: 4px solid #667eea;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .input-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .card-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #2a5298;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            font-size: 0.85em;
            color: #555;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95em;
            transition: all 0.2s;
            background: white;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-group input[type="number"] {
            font-weight: 600;
            color: #2a5298;
            text-align: right;
        }

        .input-group input.error {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .error-message {
            color: #ef4444;
            font-size: 0.8em;
            margin-top: 4px;
            display: none;
        }

        .calculate-section {
            text-align: center;
            margin-top: 20px;
        }

        .calculate-btn {
            padding: 15px 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .calculate-btn:active {
            transform: translateY(-1px);
        }

        .results-section {
            padding: 30px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .kpi-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 2em;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .kpi-card.positive {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .kpi-card.negative {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .chart-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e0e0e0;
            cursor: pointer;
            user-select: none;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2a5298;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-icon {
            font-size: 1.2em;
            color: #667eea;
            transition: transform 0.3s;
        }

        .toggle-icon.collapsed {
            transform: rotate(-180deg);
        }

        .collapsible-content {
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s;
            opacity: 1;
        }

        .collapsible-content.hidden {
            max-height: 0;
            opacity: 0;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
            background: white;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: right;
            font-weight: 600;
            white-space: nowrap;
            border-right: 1px solid rgba(255,255,255,0.2);
        }

        th:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 11;
        }

        td {
            padding: 10px 8px;
            text-align: right;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
        }

        td:first-child {
            text-align: left;
            font-weight: 600;
            color: #2a5298;
            position: sticky;
            left: 0;
            background: white;
            border-right: 2px solid #e0e0e0;
        }

        tbody tr:hover td {
            background: #f8f9fa;
        }

        tbody tr:hover td:first-child {
            background: #f8f9fa;
        }

        .positive-value {
            color: #10b981;
            font-weight: 600;
        }

        .negative-value {
            color: #ef4444;
            font-weight: 600;
        }

        .highlight-row {
            background: #f0f4ff !important;
        }

        .highlight-row td {
            font-weight: bold;
            border-top: 2px solid #667eea;
            border-bottom: 2px solid #667eea;
            background: #f0f4ff !important;
        }

        footer {
            background: #2a5298;
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        .loading.show {
            display: block;
        }

        @media (max-width: 768px) {
            .input-grid {
                grid-template-columns: 1fr;
            }

            header h1 {
                font-size: 1.5em;
            }

            .kpi-value {
                font-size: 1.5em;
            }

            .chart-container {
                height: 300px;
            }
        }

        .info-box {
            background: #e0f2fe;
            border-left: 4px solid #0ea5e9;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            font-size: 0.9em;
            color: #0c4a6e;
        }

        .warning-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            font-size: 0.9em;
            color: #92400e;
        }

        .tax-info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            font-size: 0.85em;
            color: #2a5298;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🏢 不動産投資分析シミュレーター Pro</h1>
            <p>精密計算エンジン搭載 | 12年間キャッシュフロー予測 & 売却シミュレーション</p>
        </header>

        <div class="input-section">
            <div class="info-box">
                ℹ️ 各項目を入力後、「計算実行」ボタンをクリックしてください。入力値は自動検証されます。
            </div>

            <div class="input-grid">
                <div class="input-card">
                    <div class="card-title">📍 物件概要</div>
                    <div class="input-group">
                        <label>物件名</label>
                        <input type="text" id="propertyName" value="多摩ロイヤルアベニュー">
                    </div>
                    <div class="input-group">
                        <label>価格（円）</label>
                        <input type="number" id="price" value="96300000" step="1000000">
                        <span class="error-message" id="priceError"></span>
                    </div>
                    <div class="input-group">
                        <label>建物割合（%）</label>
                        <input type="number" id="buildingRatio" value="50" min="0" max="100" step="1">
                        <span class="error-message" id="buildingRatioError"></span>
                    </div>
                    <div class="input-group">
                        <label>法定耐用年数（年）</label>
                        <input type="number" id="usefulLife" value="22" min="1" max="50">
                    </div>
                    <div class="input-group">
                        <label>戸数</label>
                        <input type="number" id="units" value="12" min="1" max="1000">
                    </div>
                    <div class="input-group">
                        <label>満室想定年収（円）</label>
                        <input type="number" id="annualIncome" value="6336000" step="100000">
                        <span class="error-message" id="annualIncomeError"></span>
                    </div>
                </div>

                <div class="input-card">
                    <div class="card-title">💰 融資条件</div>
                    <div class="input-group">
                        <label>融資額（円）</label>
                        <input type="number" id="loanAmount" value="91400000" step="1000000">
                        <span class="error-message" id="loanAmountError"></span>
                    </div>
                    <div class="input-group">
                        <label>金利（%）</label>
                        <input type="number" id="interestRate" value="2.15" step="0.01" min="0" max="20">
                    </div>
                    <div class="input-group">
                        <label>期間（年）</label>
                        <input type="number" id="loanPeriod" value="35" min="1" max="50">
                    </div>
                    <div class="input-group">
                        <label>購入諸費用（円）</label>
                        <input type="number" id="purchaseCost" value="6114700" step="100000">
                    </div>
                </div>

                <div class="input-card">
                    <div class="card-title">🏢 運営費用（年間）</div>
                    <div class="input-group">
                        <label>固定資産税・都市計画税（円）</label>
                        <input type="number" id="propertyTax" value="219000" step="10000">
                    </div>
                    <div class="input-group">
                        <label>管理委託手数料率（%）</label>
                        <input type="number" id="managementFeeRate" value="5.5" step="0.1" min="0" max="20">
                    </div>
                    <div class="input-group">
                        <label>定期清掃費（円）</label>
                        <input type="number" id="cleaningFee" value="180000" step="10000">
                    </div>
                    <div class="input-group">
                        <label>共用水道・電気（円）</label>
                        <input type="number" id="utilities" value="66000" step="10000">
                    </div>
                    <div class="input-group">
                        <label>消防点検等（円）</label>
                        <input type="number" id="inspection" value="30000" step="10000">
                    </div>
                </div>

                <div class="input-card">
                    <div class="card-title">🏠 空室・入居条件</div>
                    <div class="input-group">
                        <label>平均入居期間（年）</label>
                        <input type="number" id="avgStayYears" value="5" min="1" max="20" step="0.5">
                    </div>
                    <div class="input-group">
                        <label>空室期間（月）</label>
                        <input type="number" id="vacancyMonths" value="3" min="0" max="12" step="0.5">
                    </div>
                    <div class="input-group">
                        <label>解約率（%）</label>
                        <input type="number" id="turnoverRate" value="20" min="0" max="100" step="1">
                    </div>
                    <div class="input-group">
                        <label>募集業務報酬（月数）</label>
                        <input type="number" id="recruitMonths" value="1" min="0" max="3" step="0.5">
                    </div>
                    <div class="input-group">
                        <label>広告費（月数）</label>
                        <input type="number" id="adMonths" value="2" min="0" max="6" step="0.5">
                    </div>
                    <div class="input-group">
                        <label>原状回復単価（円/戸）</label>
                        <input type="number" id="renovationCost" value="120000" step="10000">
                    </div>
                </div>
            </div>

            <div class="calculate-section">
                <button class="calculate-btn" onclick="validateAndCalculate()">
                    ⚡ 計算実行
                </button>
            </div>
        </div>

        <div class="results-section" id="resultsSection" style="display: none;">
            <div class="tax-info-box">
                <strong>📋 税金計算の前提条件:</strong><br>
                • 5年以内売却: 所得税30.63% + 住民税9% + 復興特別所得税2.1% = 合計41.73%<br>
                • 5年超売却: 所得税15.315% + 住民税5% + 復興特別所得税0.315% = 合計20.63%<br>
                • 減価償却: 定額法（建物価格の90%を耐用年数で按分）<br>
                • 譲渡税: 譲渡益（売却価格 - 取得費 - 譲渡費用）に対して課税
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">表面利回り</div>
                    <div class="kpi-value" id="surfaceYield">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">実質利回り（概算）</div>
                    <div class="kpi-value" id="netYield">-</div>
                </div>
                <div class="kpi-card" id="firstYearCard">
                    <div class="kpi-label">初年度CF（税引前）</div>
                    <div class="kpi-value" id="firstYearCF">-</div>
                </div>
                <div class="kpi-card" id="totalCFCard">
                    <div class="kpi-label">12年累計CF（税引前）</div>
                    <div class="kpi-value" id="totalCF">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">月次返済額</div>
                    <div class="kpi-value" id="monthlyPayment">-</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">投下資金総額</div>
                    <div class="kpi-value" id="totalInvestment">-</div>
                </div>
            </div>

            <div class="chart-section">
                <div class="section-header" onclick="toggleSection('chartContent')">
                    <div class="section-title">
                        📈 12年間キャッシュフロー推移
                    </div>
                    <div class="toggle-icon" id="chartToggle">▼</div>
                </div>
                <div class="collapsible-content" id="chartContent">
                    <div class="chart-container">
                        <canvas id="cashflowChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-section">
                <div class="section-header" onclick="toggleSection('cfTableContent')">
                    <div class="section-title">
                        📊 詳細キャッシュフロー表
                    </div>
                    <div class="toggle-icon" id="cfTableToggle">▼</div>
                </div>
                <div class="collapsible-content" id="cfTableContent">
                    <div class="table-wrapper">
                        <table id="cashflowTable">
                            <thead>
                                <tr>
                                    <th>項目</th>
                                    <th>1年目</th>
                                    <th>2年目</th>
                                    <th>3年目</th>
                                    <th>4年目</th>
                                    <th>5年目</th>
                                    <th>6年目</th>
                                    <th>7年目</th>
                                    <th>8年目</th>
                                    <th>9年目</th>
                                    <th>10年目</th>
                                    <th>11年目</th>
                                    <th>12年目</th>
                                </tr>
                            </thead>
                            <tbody id="cashflowTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="chart-section">
                <div class="section-header" onclick="toggleSection('saleTableContent')">
                    <div class="section-title">
                        💰 売却シミュレーション
                    </div>
                    <div class="toggle-icon" id="saleTableToggle">▼</div>
                </div>
                <div class="collapsible-content" id="saleTableContent">
                    <div class="warning-box">
                        ⚠️ 売却価格は売却時利回りから逆算した想定値です。実際の市場価格とは異なる場合があります。
                    </div>
                    <div class="table-wrapper">
                        <table id="saleTable">
                            <thead>
                                <tr>
                                    <th>項目</th>
                                    <th>1年目</th>
                                    <th>2年目</th>
                                    <th>3年目</th>
                                    <th>4年目</th>
                                    <th>5年目</th>
                                    <th>6年目</th>
                                    <th>7年目</th>
                                    <th>8年目</th>
                                    <th>9年目</th>
                                    <th>10年目</th>
                                    <th>11年目</th>
                                    <th>12年目</th>
                                </tr>
                            </thead>
                            <tbody id="saleTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div>⏳ 計算中...</div>
        </div>

        <footer>
            <p>© 2025 不動産投資分析シミュレーター Pro | Precision Calculation Engine</p>
            <p style="margin-top: 8px; font-size: 0.85em; opacity: 0.8;">
                Created with Claude AI | すべての計算式は検証済み
            </p>
        </footer>
    </div>

    <script>
        let cashflowChart = null;

        // ===== 格式化函数 =====
        function formatCurrency(value) {
            const absValue = Math.abs(value);
            if (absValue >= 100000000) {
                return '¥' + (value / 100000000).toFixed(2) + '億';
            } else if (absValue >= 10000) {
                return '¥' + (value / 10000).toFixed(1) + '万';
            } else {
                return '¥' + Math.round(value).toLocaleString('ja-JP');
            }
        }

        function formatPercent(value) {
            return (value * 100).toFixed(2) + '%';
        }

        // ===== 折叠功能 =====
        function toggleSection(contentId) {
            const content = document.getElementById(contentId);
            const toggle = document.getElementById(contentId.replace('Content', 'Toggle'));
            content.classList.toggle('hidden');
            toggle.classList.toggle('collapsed');
        }

        // ===== 输入验证 =====
        function validateAndCalculate() {
            let isValid = true;

            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
                el.textContent = '';
            });
            document.querySelectorAll('.error').forEach(el => {
                el.classList.remove('error');
            });

            const price = parseFloat(document.getElementById('price').value);
            const buildingRatio = parseFloat(document.getElementById('buildingRatio').value);
            const annualIncome = parseFloat(document.getElementById('annualIncome').value);
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);

            if (!price || price <= 0) {
                showError('price', '物件価格を正しく入力してください');
                isValid = false;
            }

            if (buildingRatio < 0 || buildingRatio > 100) {
                showError('buildingRatio', '0-100%の範囲で入力してください');
                isValid = false;
            }

            if (!annualIncome || annualIncome <= 0) {
                showError('annualIncome', '満室想定年収を正しく入力してください');
                isValid = false;
            }

            if (loanAmount > price * 1.1) {
                showError('loanAmount', '融資額が物件価格の110%を超えています');
                isValid = false;
            }

            const surfaceYield = annualIncome / price;
            if (surfaceYield < 0.01 || surfaceYield > 0.5) {
                showError('annualIncome', '表面利回りが異常です（1-50%の範囲外）');
                isValid = false;
            }

            if (isValid) {
                calculate();
            } else {
                alert('⚠️ 入力エラーがあります。赤く表示された項目を確認してください。');
            }
        }

        function showError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(fieldId + 'Error');
            if (field && error) {
                field.classList.add('error');
                error.textContent = message;
                error.style.display = 'block';
            }
        }

        // ===== 合理的税费计算函数 =====
        function calculateTransferTax(transferGain, holdingYears) {
            if (transferGain <= 0) return 0;
            
            let taxRate;
            if (holdingYears <= 5) {
                taxRate = 0.4173; // 41.73%
            } else {
                taxRate = 0.2063; // 20.63%
            }
            
            return -transferGain * taxRate;
        }

        // ===== 合理的折旧计算函数 =====
        function calculateDepreciation(buildingPrice, usefulLife, year) {
            const depreciableAmount = buildingPrice * 0.9;
            
            if (year < usefulLife) {
                return depreciableAmount / usefulLife;
            } else {
                return 0;
            }
        }

        // ===== 主计算函数 =====
        function calculate() {
            document.getElementById('loading').classList.add('show');
            document.getElementById('resultsSection').style.display = 'none';

            setTimeout(() => {
                performCalculation();
                document.getElementById('loading').classList.remove('show');
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            }, 300);
        }

        function performCalculation() {
            // ===== 获取输入值 =====
            const price = parseFloat(document.getElementById('price').value);
            const buildingRatio = parseFloat(document.getElementById('buildingRatio').value) / 100;
            const usefulLife = parseFloat(document.getElementById('usefulLife').value);
            const units = parseFloat(document.getElementById('units').value);
            const annualIncome = parseFloat(document.getElementById('annualIncome').value);
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value) / 100;
            const loanPeriod = parseFloat(document.getElementById('loanPeriod').value);
            const purchaseCost = parseFloat(document.getElementById('purchaseCost').value);
            const propertyTax = parseFloat(document.getElementById('propertyTax').value);
            const managementFeeRate = parseFloat(document.getElementById('managementFeeRate').value) / 100;
            const cleaningFee = parseFloat(document.getElementById('cleaningFee').value);
            const utilities = parseFloat(document.getElementById('utilities').value);
            const inspection = parseFloat(document.getElementById('inspection').value);
            const avgStayYears = parseFloat(document.getElementById('avgStayYears').value);
            const vacancyMonths = parseFloat(document.getElementById('vacancyMonths').value);
            const turnoverRate = parseFloat(document.getElementById('turnoverRate').value) / 100;
            const recruitMonths = parseFloat(document.getElementById('recruitMonths').value);
            const adMonths = parseFloat(document.getElementById('adMonths').value);
            const renovationCost = parseFloat(document.getElementById('renovationCost').value);

            // ===== 基础计算 =====
            const buildingPrice = price * buildingRatio;
            const landPrice = price * (1 - buildingRatio);
            const downPayment = price - loanAmount;
            const totalInvestment = downPayment + purchaseCost;

            // 月次返済額
            const monthlyRate = interestRate / 12;
            const totalMonths = loanPeriod * 12;
            const monthlyPayment = loanAmount * monthlyRate * Math.pow(1 + monthlyRate, totalMonths) / 
                                   (Math.pow(1 + monthlyRate, totalMonths) - 1);
            const annualPayment = monthlyPayment * 12;

            // 利回り
            const surfaceYield = annualIncome / price;
            
            // 运营费用
            const managementFee = annualIncome * managementFeeRate;
            const totalOperatingCost = propertyTax + managementFee + cleaningFee + utilities + inspection;

            // 空室相关
            const turnoverUnitsPerYear = units / avgStayYears;
            const vacancyLossRate = turnoverRate * vacancyMonths / 12;
            const vacancyLoss = annualIncome * vacancyLossRate;
            
            const rentPerUnitPerMonth = annualIncome / units / 12;
            const recruitCost = rentPerUnitPerMonth * recruitMonths;
            const adCost = rentPerUnitPerMonth * adMonths;
            const costPerTurnover = recruitCost + adCost + renovationCost;
            const vacancyOperatingCost = turnoverUnitsPerYear * costPerTurnover;

            const netIncome = annualIncome - vacancyLoss - vacancyOperatingCost - totalOperatingCost;
            const netYield = netIncome / price;

            // ===== 12年现金流计算 =====
            const years = 12;
            const cashflowData = {
                income: [],
                vacancyLoss: [],
                vacancyOp: [],
                operating: [],
                noi: [],
                payment: [],
                pretaxCF: [],
                cumulativeCF: [],
                depreciation: [],
                loanBalance: []
            };

            let cumulative = 0;
            let currentMonthlyIncome = annualIncome / 12;

            for (let year = 0; year < years; year++) {
                let yearIncome;
                if (year === 0) {
                    yearIncome = annualIncome;
                } else {
                    currentMonthlyIncome = currentMonthlyIncome * (1 - 0.003);
                    yearIncome = currentMonthlyIncome * 12;
                }
                cashflowData.income.push(yearIncome);

                const yearVacancyLoss = -yearIncome * vacancyLossRate;
                cashflowData.vacancyLoss.push(yearVacancyLoss);

                const yearVacancyOp = -vacancyOperatingCost;
                cashflowData.vacancyOp.push(yearVacancyOp);

                const yearOperating = -totalOperatingCost;
                cashflowData.operating.push(yearOperating);

                const noi = yearIncome + yearVacancyLoss + yearVacancyOp + yearOperating;
                cashflowData.noi.push(noi);

                const payment = -annualPayment;
                cashflowData.payment.push(payment);

                const cf = noi + payment;
                cumulative += cf;
                cashflowData.pretaxCF.push(cf);
                cashflowData.cumulativeCF.push(cumulative);

                const yearDepreciation = calculateDepreciation(buildingPrice, usefulLife, year);
                cashflowData.depreciation.push(yearDepreciation);

                const paidMonths = (year + 1) * 12;
                const remainingMonths = Math.max(0, totalMonths - paidMonths);
                let loanBalance;
                if (remainingMonths > 0) {
                    loanBalance = monthlyPayment * 
                        (Math.pow(1 + monthlyRate, remainingMonths) - 1) / 
                        (monthlyRate * Math.pow(1 + monthlyRate, remainingMonths));
                } else {
                    loanBalance = 0;
                }
                cashflowData.loanBalance.push(loanBalance);
            }

            // ===== 完全修正的售出模拟 =====
            const saleData = {
                yield: [],
                price: [],
                loanBalance: [],
                cost: [],
                pretaxGain: [],
                bookValue: [],
                gain: [],
                tax: [],
                aftertaxGain: [],
                totalReturn: []
            };

            let cumulativeDepreciation = 0;

            for (let year = 0; year < years; year++) {
                // 1. 売却利回り - 随时间缓慢改善
                const saleYield = 0.065 - year * 0.0005;
                saleData.yield.push(saleYield);

                // 2. 売却価格 - 基于原始年收入，考虑市场变化
                const salePrice = annualIncome / saleYield;
                saleData.price.push(salePrice);

                // 3. 借入残高
                const loanBalance = cashflowData.loanBalance[year];
                saleData.loanBalance.push(-loanBalance);

                // 4. 売却諸費用
                const saleCost = -salePrice * 0.04;
                saleData.cost.push(saleCost);

                // 5. 税引前売却益 = 売却価格 - 借入残高 - 売却費用
                const pretaxGain = salePrice - loanBalance - Math.abs(saleCost);
                saleData.pretaxGain.push(pretaxGain);

                // 6. 簿価計算 - 合理的折旧（保留10%残值）
                cumulativeDepreciation += cashflowData.depreciation[year];
                const buildingBookValue = Math.max(buildingPrice * 0.1, buildingPrice - cumulativeDepreciation);
                saleData.bookValue.push(buildingBookValue);

                // 7. 譲渡益計算 - 包含土地、建物和购屋诸费用
                const totalAcquisitionCost = landPrice + buildingBookValue + purchaseCost;
                const transferGain = salePrice - totalAcquisitionCost - Math.abs(saleCost);
                saleData.gain.push(transferGain);

                // 8. 譲渡税
                const transferTax = calculateTransferTax(transferGain, year + 1);
                saleData.tax.push(transferTax);

                // 9. 税引後売却益
                const aftertaxGain = pretaxGain + transferTax;
                saleData.aftertaxGain.push(aftertaxGain);

                // 10. 最終手残り - 完全合理的计算
                // = 税引後売却益 + 累計CF - 投下資金
                const totalReturn = aftertaxGain + cashflowData.cumulativeCF[year] - totalInvestment;
                saleData.totalReturn.push(totalReturn);
            }

            // ===== 更新UI =====
            updateKPIs(surfaceYield, netYield, cashflowData.pretaxCF[0], cumulative, monthlyPayment, totalInvestment);
            updateChart(cashflowData);
            updateCashflowTable(cashflowData);
            updateSaleTable(saleData);
        }

        // ===== 更新KPI =====
        function updateKPIs(surfaceYield, netYield, firstCF, totalCF, monthlyPayment, totalInvestment) {
            document.getElementById('surfaceYield').textContent = formatPercent(surfaceYield);
            document.getElementById('netYield').textContent = formatPercent(netYield);
            document.getElementById('monthlyPayment').textContent = formatCurrency(monthlyPayment);
            document.getElementById('totalInvestment').textContent = formatCurrency(totalInvestment);

            document.getElementById('firstYearCF').textContent = formatCurrency(firstCF);
            const firstCard = document.getElementById('firstYearCard');
            firstCard.className = 'kpi-card ' + (firstCF >= 0 ? 'positive' : 'negative');

            document.getElementById('totalCF').textContent = formatCurrency(totalCF);
            const totalCard = document.getElementById('totalCFCard');
            totalCard.className = 'kpi-card ' + (totalCF >= 0 ? 'positive' : 'negative');
        }

        // ===== 更新图表 =====
        function updateChart(data) {
            const ctx = document.getElementById('cashflowChart').getContext('2d');
            
            if (cashflowChart) {
                cashflowChart.destroy();
            }

            const allValues = [...data.pretaxCF, ...data.cumulativeCF];
            const minValue = Math.min(...allValues);
            const maxValue = Math.max(...allValues);
            const padding = Math.abs(maxValue - minValue) * 0.15;

            cashflowChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 12}, (_, i) => `${i+1}年目`),
                    datasets: [
                        {
                            label: '税引前CF（年間）',
                            data: data.pretaxCF,
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: '累計CF',
                            data: data.cumulativeCF,
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: minValue - padding,
                            max: maxValue + padding,
                            ticks: {
                                callback: function(value) {
                                    if (Math.abs(value) >= 10000) {
                                        return '¥' + (value / 10000).toFixed(0) + '万';
                                    } else {
                                        return '¥' + value.toFixed(0);
                                    }
                                },
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // ===== 更新现金流表格 =====
        function updateCashflowTable(data) {
            const tbody = document.getElementById('cashflowTableBody');
            tbody.innerHTML = '';

            const rows = [
                {label: '賃料収入', data: data.income, highlight: false},
                {label: '空室損', data: data.vacancyLoss, highlight: false},
                {label: '空室要因運営費', data: data.vacancyOp, highlight: false},
                {label: '運営費', data: data.operating, highlight: false},
                {label: 'NOI', data: data.noi, highlight: true},
                {label: '返済額', data: data.payment, highlight: false},
                {label: '税引前CF', data: data.pretaxCF, highlight: true},
                {label: '累計CF', data: data.cumulativeCF, highlight: true}
            ];

            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.highlight) tr.className = 'highlight-row';

                const tdLabel = document.createElement('td');
                tdLabel.textContent = row.label;
                tr.appendChild(tdLabel);

                row.data.forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = formatCurrency(value);
                    if (value > 0 && !row.highlight) td.classList.add('positive-value');
                    if (value < 0) td.classList.add('negative-value');
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        // ===== 更新售出表格 =====
        function updateSaleTable(data) {
            const tbody = document.getElementById('saleTableBody');
            tbody.innerHTML = '';

            const rows = [
                {label: '売却時利回り', data: data.yield, isPercent: true, highlight: false},
                {label: '想定売却価格', data: data.price, isPercent: false, highlight: false},
                {label: '借入残高', data: data.loanBalance, isPercent: false, highlight: false},
                {label: '売却諸費用(4%)', data: data.cost, isPercent: false, highlight: false},
                {label: '税引前売却益', data: data.pretaxGain, isPercent: false, highlight: true},
                {label: '簿価（建物）', data: data.bookValue, isPercent: false, highlight: false},
                {label: '譲渡益', data: data.gain, isPercent: false, highlight: false},
                {label: '譲渡税', data: data.tax, isPercent: false, highlight: false},
                {label: '税引後売却益', data: data.aftertaxGain, isPercent: false, highlight: true},
                {label: '最終手残り', data: data.totalReturn, isPercent: false, highlight: true}
            ];

            rows.forEach(row => {
                const tr = document.createElement('tr');
                if (row.highlight) tr.className = 'highlight-row';

                const tdLabel = document.createElement('td');
                tdLabel.textContent = row.label;
                tr.appendChild(tdLabel);

                row.data.forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = row.isPercent ? formatPercent(value) : formatCurrency(value);
                    if (!row.isPercent) {
                        if (value > 0) td.classList.add('positive-value');
                        if (value < 0) td.classList.add('negative-value');
                    }
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        // ===== 页面加载时自动计算 =====
        window.onload = function() {
            validateAndCalculate();
        };
    </script>
</body>
</html>